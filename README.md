This is the official PyTorch codes for the paper:

>**PISA: Anchoring Discrete Priors with Physical Structures for Real-World Generative Dehazing**<br>


## :wrench: Dependencies and Installation

Install packages

```bash
conda create -n pisa python=3.8
conda activate pisa
pip install -r requirements.txt
```

## ðŸš€ Quick Inference
### Step1: Downloading pretrained checkpoints
Download <a href="https://drive.google.com/file/d/1CGYIlOejr-_vv084JygxhUxWjLxXs5O-/view?usp=sharing">predictor.pth</a> and place it in the following directories: `pretrained_models`


### Step2: Running testing command
```bash
python inference.py -i examples -o results 
```
### Option: Downloading test datasets
<table>
<thead>
<tr>
    <th> Dataset </th>
    <th>:link: Download Links </th>
</tr>
</thead>
<tbody>
<tr>
    <td>URHI</td>
    <th>
    <a href="https://utexas.app.box.com/s/2yekra41udg9rgyzi3ysi513cps621qz">Download</a></th>
</tr>
<tr>
    <td>RTTS</td>
    <th>
    <a href="https://utexas.app.box.com/s/7hu094vwkw0cwowv5wijwv9pure2fvup?page=2">Download</a></th>
</tr>
</tbody>
</table>

## :muscle: Train
### Step1: Prepare training dataset
Preparing data for training(same to <a href="https://github.com/RQ-Wu/RIDCP_dehazing">RIDCP</a>)
<table>
<thead>
<tr>
    <th>Dataset</th>
    <th> Description </th>
    <th>:link: Download Links </th>
</tr>
</thead>
<tbody>
<tr>
    <td>rgb_500</td>
    <th>500 clear RGB images as the input of our phenomenological degradation pipeline</th>
    <th rowspan="2">
    [<a href="https://pan.baidu.com/s/1oX3AZkVlEa7S1sSO12r47Q">Baidu Disk (pwd: qqqo)</a>]
    </th>
</tr>
<tr>
    <td>depth_500</td>
    <th>Corresponding depth map generated by RA-Depth(https://github.com/hmhemu/RA-Depth).</th>
</tr>
<tr>
    <td>Flick2K, DIV2K</td>
    <th>High-quality data for VQGAN pre-training</th>
    <th>-</th>
</tr>
</tbody>
</table>

The final directory structure will be arranged as:
```
datasets
    |- train
        |- rgb_500
            |- xxx.jpg
            |- ...
        |- depth_500
            |- xxx.npy
            |- ...
        |- HQ_sub

pretrained_models
    |- net_predictor.pth

```
### Step2: Running training command
For training Predictor:
```bash
sh train_predictor.sh
```
ðŸ’» Quantitative Evaluation

![quan_img](.assets/quantitative_results.png)



The code is improved based on the baseline method <a href="https://github.com/Jiayi-Fu/IPC-Dehaze">IPCdehaze</a>.

